name: ðŸš€ CI/CD Pipeline

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

jobs:
  # ===================================================
  # 1. TESTS & LINT (Backend + Frontend)
  # ===================================================
  tests:
    name: ðŸ§ª Run Tests & Lint
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_DB: cinezone_test
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      # Installation correcte de PNPM
      - name: ðŸŸ¢ Setup PNPM
        uses: pnpm/action-setup@v3
        with:
          version: 9

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      # Installation unique pour tout le monorepo
      - name: ðŸ“¦ Install dependencies
        run: pnpm install --frozen-lockfile

      # Backend Tests
      - name: ðŸ—„ï¸ Setup test database
        working-directory: apps/backend
        env:
          DB_HOST: localhost
          DB_PORT: 5432
          DB_NAME: cinezone_test
          DB_USER: postgres
          DB_PASSWORD: postgres
        run: pnpm run db:init

      - name: ðŸ§ª Run Backend Tests
        working-directory: apps/backend
        env:
          NODE_ENV: test
          DB_HOST: localhost
          DB_PORT: 5432
          DB_NAME: cinezone_test
          DB_USER: postgres
          DB_PASSWORD: postgres
          JWT_SECRET: test_secret
          JWT_REFRESH_SECRET: test_refresh_secret
        run: pnpm test

      # Frontend Tests
      - name: ðŸ§ª Run Frontend Tests
        working-directory: apps/frontend
        run: pnpm test:unit # Assurez-vous que ce script existe dans package.json

      # Linting (Sans le || true pour bloquer si erreurs)
      - name: ðŸ” Lint Code
        run: pnpm run lint

  # ===================================================
  # 2. DEPLOY (Seulement si les tests passent)
  # ===================================================
  deploy:
    name: ðŸš€ Deploy to VPS
    needs: tests # C'est ICI la clÃ© : on attend que les tests soient OK
    if: github.ref == 'refs/heads/master' # Seulement sur la branche master
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: ðŸ” Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: ðŸ“ Add VPS to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

      - name: ðŸš€ Execute Deploy Script via SSH
        env:
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_HOST: ${{ secrets.VPS_HOST }}
          APP_DIR: /var/www/cinezone
        run: |
          ssh $VPS_USER@$VPS_HOST << 'EOF'
            cd ${{ env.APP_DIR }}
          
            echo "ðŸ”„ Pulling latest code..."
            git pull origin master
          
            # S'assurer que le script est exÃ©cutable
            chmod +x scripts/deploy.sh
          
            echo "ðŸ”¨ Building and deploying..."
            bash scripts/deploy.sh
          
            echo "âœ… Deployment completed!"
          EOF
